<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotmate</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: #1e1e1e;
            border-radius: 24px;
            padding: 48px;
            text-align: center;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .logo-img {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin: 0 auto 24px;
            display: block;
            object-fit: cover;
        }
        .icon-circle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            animation: pop 0.4s ease-out;
        }
        .icon-circle.success {
            background: #10b981;
        }
        .icon-circle.reset {
            background: #C2FF40;
        }
        .icon-circle svg {
            width: 32px;
            height: 32px;
            stroke-width: 3;
        }
        .icon-circle.success svg {
            stroke: white;
        }
        .icon-circle.reset svg {
            stroke: #010101;
        }
        @keyframes pop {
            0% { transform: scale(0); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        h1 {
            color: #ffffff;
            font-size: 28px;
            margin-bottom: 12px;
        }
        p {
            color: #9ca3af;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .button {
            display: inline-block;
            background: #C2FF40;
            color: #010101;
            text-decoration: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(194, 255, 64, 0.3);
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .footer {
            margin-top: 24px;
            color: #6b7280;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 16px;
            text-align: left;
        }
        .form-group label {
            display: block;
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            background: #2a2a2a;
            border: 1.5px solid #3a3a3a;
            border-radius: 12px;
            color: #ffffff;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #C2FF40;
        }
        .form-group input::placeholder {
            color: #6b7280;
        }
        .error-message {
            background: #ef444420;
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .password-requirements {
            color: #6b7280;
            font-size: 12px;
            text-align: left;
            margin-top: 8px;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #010101;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="icon.png" alt="Spotmate" class="logo-img">

        <!-- Email Confirmed View -->
        <div id="email-confirmed" class="view">
            <div class="icon-circle success">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h1>Email Confirmed!</h1>
            <p>Your email has been verified successfully. You can now open the Spotmate app and sign in to start finding activity partners.</p>
            <button class="button" onclick="openApp()">Open Spotmate App</button>
            <div class="footer">You can close this page now</div>
        </div>

        <!-- Password Reset View -->
        <div id="password-reset" class="view">
            <div class="icon-circle reset">
                <svg viewBox="0 0 24 24" fill="none">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h1>Reset Password</h1>
            <p>Enter your new password below.</p>

            <div id="reset-error" class="error-message"></div>

            <form id="reset-form">
                <div class="form-group">
                    <label for="password">New Password</label>
                    <input type="password" id="password" placeholder="Enter new password" required minlength="6">
                    <div class="password-requirements">Must be at least 6 characters</div>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" placeholder="Confirm new password" required minlength="6">
                </div>
                <button type="submit" class="button" id="reset-button">Reset Password</button>
            </form>
            <div class="footer">Remember your password? Open the app to sign in</div>
        </div>

        <!-- Password Reset Success View -->
        <div id="password-success" class="view">
            <div class="icon-circle success">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h1>Password Updated!</h1>
            <p>Your password has been reset successfully. You can now sign in to the Spotmate app with your new password.</p>
            <button class="button" onclick="openApp()">Open Spotmate App</button>
            <div class="footer">You can close this page now</div>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Your Supabase credentials
        var SUPABASE_URL = 'https://wfwwbwpspfibrvygrmjt.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indmd3did3BzcGZpYnJ2eWdybWp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODQ3MjAsImV4cCI6MjA4MzQ2MDcyMH0.JIyEqC4itoNvdmqQyvPQ2aiZpHewopkxs7wd7-7cdRA';

        var supabaseClient = null;
        var accessToken = null;
        var refreshToken = null;

        // Parse URL hash parameters
        function getHashParams() {
            var hash = window.location.hash.substring(1);
            var params = {};
            var parts = hash.split('&');
            for (var i = 0; i < parts.length; i++) {
                var pair = parts[i].split('=');
                if (pair[0] && pair[1]) {
                    params[pair[0]] = decodeURIComponent(pair[1]);
                }
            }
            return params;
        }

        // Show a specific view
        function showView(viewId) {
            var views = document.querySelectorAll('.view');
            for (var i = 0; i < views.length; i++) {
                views[i].classList.remove('active');
            }
            var targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }

            // Update page title
            if (viewId === 'password-reset') {
                document.title = 'Reset Password - Spotmate';
            } else if (viewId === 'email-confirmed' || viewId === 'password-success') {
                document.title = 'Success - Spotmate';
            }
        }

        // Show error message
        function showError(message) {
            var errorDiv = document.getElementById('reset-error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Hide error message
        function hideError() {
            var errorDiv = document.getElementById('reset-error');
            errorDiv.classList.remove('show');
        }

        // Handle password reset form submission
        function handleResetPassword(event) {
            event.preventDefault();
            hideError();

            var password = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirm-password').value;
            var button = document.getElementById('reset-button');

            // Validate passwords match
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            // Validate password length
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            // Show loading state
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Updating...';

            // Update password using Supabase
            if (supabaseClient) {
                supabaseClient.auth.updateUser({ password: password })
                    .then(function(response) {
                        if (response.error) {
                            showError(response.error.message || 'Failed to reset password. Please try again.');
                            button.disabled = false;
                            button.textContent = 'Reset Password';
                        } else {
                            showView('password-success');
                        }
                    })
                    .catch(function(err) {
                        showError('An unexpected error occurred. Please try again.');
                        button.disabled = false;
                        button.textContent = 'Reset Password';
                    });
            } else {
                showError('Unable to connect. Please try again later.');
                button.disabled = false;
                button.textContent = 'Reset Password';
            }
        }

        // Open the Spotmate app
        function openApp() {
            window.location.href = 'spotmate://signin';
            setTimeout(function() {
                alert('Please open the Spotmate app and sign in!');
            }, 1000);
        }

        // Initialize page
        function init() {
            var params = getHashParams();

            // Store tokens
            accessToken = params.access_token;
            refreshToken = params.refresh_token;

            // Check if this is a password recovery
            if (params.type === 'recovery' && accessToken) {
                showView('password-reset');

                // Initialize Supabase and set session
                if (typeof supabase !== 'undefined') {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    supabaseClient.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken || ''
                    }).then(function(result) {
                        if (result.error) {
                            console.error('Session error:', result.error);
                            showError('Invalid or expired reset link. Please request a new one.');
                        }
                    }).catch(function(err) {
                        console.error('Session error:', err);
                    });
                }
            } else {
                // Default to email confirmed view
                showView('email-confirmed');
            }

            // Setup form handler
            var form = document.getElementById('reset-form');
            if (form) {
                form.onsubmit = handleResetPassword;
            }
        }

        // Run init when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
